<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="description" content="kindquiet"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="/atom.xml" title="kindquiet素食勤俭敬老孝慈" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><title>计算机 - kindquiet素食勤俭敬老孝慈</title><script>var _hmt = _hmt || [];(function() {  var hm = document.createElement("script");  hm.src = "//hm.baidu.com/hm.js?33ec0e4a308e2f174e68f15c700d8b5d";  var s = document.getElementsByTagName("script")[0];   s.parentNode.insertBefore(hm, s);})();</script><link rel="stylesheet" href="/css/style.css" type="text/css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--></head><body><header class="site-head"><div class="inner"><h1 class="site-title u-fl"><a href="/">kindquiet素食勤俭敬老孝慈</a></h1><nav class="site-nav u-fr"><ul class="site-nav__list"><li class="site-nav__item"><a href="/" class="site-nav__link">Home</a></li><li class="site-nav__item"><a href="/archives" class="site-nav__link">Archives</a></li></ul></nav></div></header><section class="site-content"><main class="site-main"><article class="post"><header class="post__head"><time datetime="2011-08-05T08:51:59.000Z" class="post__time">八月 5, 2011</time><h1 class="post__title"><a href="/2011/08/05/w/centos-4-e5-8d-87-e7-ba-a7-e5-88-b04-9/">centos 4升级到4.9</a></h1></header><div class="post__main"><p>centos 4升级yum后yum不能使用解决办法。</p>
<pre><code>Yum fails &amp;quot;<span class="built_in">GLib</span>-CRITICAL&amp;quot;
</code></pre><p>yum check-update</p>
<pre><code>(<span class="built_in">process</span>:<span class="number">25406</span>): GLib-CRITICAL **: <span class="built_in">file</span> gtimer.c: <span class="built_in">line</span> <span class="number">106</span> (g_timer_stop): assertion `timer != <span class="constant">NULL</span>&amp;<span class="comment">#39; failed</span>

(<span class="built_in">process</span>:<span class="number">25406</span>): GLib-CRITICAL **: <span class="built_in">file</span> gtimer.c: <span class="built_in">line</span> <span class="number">88</span> (g_timer_destroy): assertion `timer != <span class="constant">NULL</span>&amp;<span class="comment">#39; failed</span>

TypeError: Can <span class="operator">not</span> <span class="built_in">create</span> index <span class="command"><span class="keyword">on</span> <span class="title">requires</span> <span class="title">table</span>: <span class="title">near</span> &amp;<span class="title">quot</span>;<span class="title">NOT</span>&amp;<span class="title">quot</span>;: <span class="title">syntax</span> <span class="title">error</span></span>

方法：

rpm -Uvh <span class="keyword">http</span>://mirrors.sohu.com/centos/<span class="number">4.8</span>/os/i386/CentOS/RPMS/sqlite-<span class="number">3.3</span><span class="number">.6</span>-<span class="number">2.</span>i386.rpm

rpm -Uvh <span class="keyword">http</span>://mirrors.sohu.com/centos/<span class="number">4.8</span>/os/i386/CentOS/RPMS/sqlite-devel-<span class="number">3.3</span><span class="number">.6</span>-<span class="number">2.</span>i386.rpm
</code></pre><p>然后</p>
<p>mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</p>
<p>wget <a href="http://mirrors.163.com/.help/CentOS4-Base-163.repo" target="_blank" rel="external">http://mirrors.163.com/.help/CentOS4-Base-163.repo</a> -O /etc/yum.repos.d/CentOS-Base.repo</p>
<p>yum clean all</p>
<pre><code>yum <span class="keyword">update</span> kernel* -<span class="literal">y</span>

yum <span class="keyword">update</span> glibc\* -<span class="literal">y</span>

yum <span class="keyword">update</span> yum\* rpm\* pyth\* -<span class="literal">y</span>

yum <span class="keyword">update</span> mkinitrd nash -<span class="literal">y</span>

yum <span class="keyword">update</span> selinux\* -<span class="literal">y</span>

yum <span class="keyword">update</span> -<span class="literal">y</span>

shutdown -rf now

&amp;nbsp;
</code></pre><p>参考：Yum &quot;GLib-CRITICAL&quot; How To Fix</p>
<pre><code><span class="string">http:</span><span class="comment">//sysadmingear.blogspot.com/2008/07/yum-glib-critical-how-to-fix.html</span>
</code></pre></div><footer class="post__foot u-cf"><a href="/2011/08/05/w/centos-4-e5-8d-87-e7-ba-a7-e5-88-b04-9/#comments" class="post__foot-link u-fr">评论</a></footer></article><article class="post"><header class="post__head"><time datetime="2011-07-26T09:44:47.000Z" class="post__time">七月 26, 2011</time><h1 class="post__title"><a href="/2011/07/26/w/e6-9f-a5-e7-9c-8blinux-e5-8f-91-e8-a1-8c-e7-89-88-e4-bf-a1-e6-81-af-lsb-release/">查看Linux发行版信息-lsb_release</a></h1></header><div class="post__main"><p>LSB是Linux Standard Base的缩写，lsb_release命令用来显示LSB和特定版本的相关信息，centos可通过</p>
<pre><code>yum -y install redhat-lsb

命令安装。如果使用该命令时不带参数，则默认加上-v参数。

查看Linux发行版信息:

lsb_release -<span class="tag">a</span>

查询rpm安装包名称:

yum whatprovides */lsb_release
</code></pre></div><footer class="post__foot u-cf"><a href="/2011/07/26/w/e6-9f-a5-e7-9c-8blinux-e5-8f-91-e8-a1-8c-e7-89-88-e4-bf-a1-e6-81-af-lsb-release/#comments" class="post__foot-link u-fr">评论</a></footer></article><article class="post"><header class="post__head"><time datetime="2011-07-13T02:41:47.000Z" class="post__time">七月 13, 2011</time><h1 class="post__title"><a href="/2011/07/13/w/e7-b3-bb-e7-bb-9f-e6-97-a5-e5-bf-97syslog-e4-b8-8d-e8-ae-b0-e5-bd-95snmpd-e6-97-a5-e5-bf-97/">系统日志syslog不记录snmpd日志</a></h1></header><div class="post__main"><p>系统为centos linux 5.6。启动snmpd做流量统计，系统日志充斥大量snmpd日志</p>
<pre><code>Jul <span class="number">10</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">59</span> lb snmpd[<span class="number">1821</span>]: Connection from <span class="string">UDP:</span> [<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>]:<span class="number">34179</span>

Jul <span class="number">10</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">59</span> lb snmpd[<span class="number">1821</span>]: Received SNMP packet(s) from <span class="string">UDP:</span> [<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>]:<span class="number">34179</span>

修改：

vim <span class="regexp">/etc/</span>sysconfig/snmpd.options

#加入如下参数

OPTIONS=&amp;quot;-LS3d -Lf <span class="regexp">/dev/</span><span class="literal">null</span> -p <span class="regexp">/var/</span>run/snmpd.pid -a&amp;quot;

chmod +x <span class="regexp">/etc/</span>sysconfig/snmpd.options

重启：

<span class="regexp">/etc/</span>init.d/snmpd restart
</code></pre></div><footer class="post__foot u-cf"><a href="/2011/07/13/w/e7-b3-bb-e7-bb-9f-e6-97-a5-e5-bf-97syslog-e4-b8-8d-e8-ae-b0-e5-bd-95snmpd-e6-97-a5-e5-bf-97/#comments" class="post__foot-link u-fr">评论</a></footer></article><article class="post"><header class="post__head"><time datetime="2011-07-11T02:04:24.000Z" class="post__time">七月 11, 2011</time><h1 class="post__title"><a href="/2011/07/11/w/awstats-e5-88-86-e6-9e-90-e7-bb-9f-e8-ae-a1squid-e6-97-a5-e5-bf-97/">awstats分析统计squid日志</a></h1></header><div class="post__main"><p>关键：squid自定义日志格式中combined %&gt;a和之间只可有一个空格分隔，如果多于一个，squid日志中每行行首会有前置空格，分析时会报错： Found 6 corrupted records。</p>
<p>以下测试在centos linux中通过。</p>
<pre><code>squid配置：

#logformat combined&amp;nbsp; <span class="variable">%&amp;</span>gt;a <span class="variable">%ui</span> <span class="variable">%un</span> [<span class="variable">%tl</span>] &amp;quot;<span class="variable">%rm</span> <span class="variable">%ru</span> HTTP/<span class="variable">%rv</span>&amp;quot; <span class="variable">%&amp;</span>gt;Hs <span class="variable">%&amp;</span>lt;st &amp;quot;<span class="variable">%{Referer}</span>&amp;gt;h&amp;quot; &amp;quot;%{User-Agent}&amp;gt;h&amp;quot; <span class="variable">%Ss</span>:<span class="variable">%Sh</span>

logformat combined <span class="variable">%&amp;</span>gt;a <span class="variable">%ui</span> <span class="variable">%un</span> [<span class="variable">%tl</span>] &amp;quot;<span class="variable">%rm</span> <span class="variable">%ru</span> HTTP/<span class="variable">%rv</span>&amp;quot; <span class="variable">%&amp;</span>gt;Hs <span class="variable">%&amp;</span>lt;st &amp;quot;<span class="variable">%{Referer}</span>&amp;gt;h&amp;quot; &amp;quot;%{User-Agent}&amp;gt;h&amp;quot; <span class="variable">%Ss</span>:<span class="variable">%Sh</span> <span class="variable">%{host}</span>&amp;gt;h

access_log /var/squid/logs/access.<span class="keyword">log</span> combined

logfile_rotate <span class="number">10</span>
</code></pre><p>日志类似：10.168.6.166 - - [11/Jul/2011:10:16:42 +0800] &quot;POST <a href="http://veryi.com/getconf.php" target="_blank" rel="external">http://veryi.com/getconf.php</a> HTTP/1.1&quot; 200 960 &quot;-&quot; &quot;Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 2.0.50727)&quot; TCP_MISS:DIRECT veryi.com</p>
<pre><code>或者配置为：
</code></pre><p>emulate_httpd_log on</p>
<p>日志类似：10.168.6.54 - - [11/Jul/2011:09:21:02 +0800] &quot;GET <a href="http://veryi.com/20110705/10/aedf8255-14da-48c5-9338-296caceaf645.jpg" target="_blank" rel="external">http://veryi.com/20110705/10/aedf8255-14da-48c5-9338-296caceaf645.jpg</a> HTTP/1.1&quot; 200 22328 TCP_MISS:DIRECT</p>
<pre><code>awstats配置：

LogFormat=<span class="number">4</span>

#LogFormat = &amp;quot;<span class="variable">%host</span> <span class="variable">%other</span> <span class="variable">%logname</span> <span class="variable">%time1</span> <span class="variable">%methodurl</span> <span class="variable">%code</span> <span class="variable">%bytesd</span> <span class="variable">%refererquot</span> <span class="variable">%uaquot</span> <span class="variable">%other</span> <span class="variable">%virtualname</span>&amp;quot;
</code></pre><p>使用预定义格式即可，自定义报corrupted records错。</p>
<pre><code>squid日志分隔脚本：squid_log.sh

export PATH=/bin:/usr/bin

bakdir=`date +%Y`

baklog=access.log-`date +%Y%m%d%H`

/usr/local/squid/sbin/squid -k rotate

cd /<span class="keyword">var</span>/squid/logs

[ -d `date +%Y` ] || mkdir `date +%Y`

mv access.log.<span class="number">9</span> $bakdir

cd $bakdir

mv access.log.<span class="number">9</span> access.log-`date +%Y%m%d%H`

/usr/bin/bzip2 -<span class="number">1</span> $baklog

find . -name &amp;<span class="string">#39</span>;*log*&amp;<span class="string">#39</span>; -mtime +<span class="number">90</span> -<span class="keyword">type</span> f -exec rm -f <span class="comment">{}</span> \;

awstats自定义字段说明：

#&amp;nbsp;&amp;nbsp; %host&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Client hostname <span class="keyword">or</span> IP address (<span class="keyword">or</span> Sender host <span class="keyword">for</span> mail log)

#&amp;nbsp;&amp;nbsp; %host_r&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Receiver hostname <span class="keyword">or</span> IP address (<span class="keyword">for</span> mail log)

#&amp;nbsp;&amp;nbsp; %lognamequot&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Authenticated login/user <span class="keyword">with</span> format: &amp;quot;john&amp;quot;

#&amp;nbsp;&amp;nbsp; %logname&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Authenticated login/user <span class="keyword">with</span> format: john

#&amp;nbsp;&amp;nbsp; %time1&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Date <span class="keyword">and</span> time <span class="keyword">with</span> format: [dd/mon/yyyy:hh:mm:ss +<span class="number">0000</span>] <span class="keyword">or</span> [dd/mon/yyyy:hh:mm:ss]

#&amp;nbsp;&amp;nbsp; %time2&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Date <span class="keyword">and</span> time <span class="keyword">with</span> format: yyyy-mm-dd hh:mm:ss

#&amp;nbsp;&amp;nbsp; %time3&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Date <span class="keyword">and</span> time <span class="keyword">with</span> format: Mon dd hh:mm:ss <span class="keyword">or</span> Mon dd hh:mm:ss yyyy

#&amp;nbsp;&amp;nbsp; %time4&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Date <span class="keyword">and</span> time <span class="keyword">with</span> unix timestamp format: dddddddddd

#&amp;nbsp;&amp;nbsp; %methodurl&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; <span class="function"><span class="keyword">Method</span> <span class="title">and</span> <span class="title">URL</span> <span class="title">with</span> <span class="title">format</span>:</span> &amp;quot;GET /<span class="keyword">index</span>.html HTTP/x.x&amp;quot;

#&amp;nbsp;&amp;nbsp; %methodurlnoprot&amp;nbsp; <span class="function"><span class="keyword">Method</span> <span class="title">and</span> <span class="title">URL</span> <span class="title">with</span> <span class="title">format</span>:</span> &amp;quot;GET /<span class="keyword">index</span>.html&amp;quot;

#&amp;nbsp;&amp;nbsp; %<span class="function"><span class="keyword">method</span>&amp;<span class="title">nbsp</span>;</span>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; <span class="function"><span class="keyword">Method</span> <span class="title">with</span> <span class="title">format</span>:</span> GET

#&amp;nbsp;&amp;nbsp; %url&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; URL only <span class="keyword">with</span> format: /<span class="keyword">index</span>.html

#&amp;nbsp;&amp;nbsp; %query&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Query string (used <span class="keyword">by</span> URLWithQuery option)

#&amp;nbsp;&amp;nbsp; %code&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Return code status (<span class="keyword">with</span> format <span class="keyword">for</span> web log: <span class="number">999</span>)

#&amp;nbsp;&amp;nbsp; %bytesd&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Size <span class="keyword">of</span> document <span class="keyword">in</span> bytes

#&amp;nbsp;&amp;nbsp; %refererquot&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Referer page <span class="keyword">with</span> format: &amp;quot;http:<span class="comment">//from.com/from.htm&amp;quot;</span>

#&amp;nbsp;&amp;nbsp; %referer&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Referer page <span class="keyword">with</span> format: http:<span class="comment">//from.com/from.htm</span>

#&amp;nbsp;&amp;nbsp; %uabracket&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; User agent <span class="keyword">with</span> format: [Mozilla/<span class="number">4.0</span> (compatible, ...)]

#&amp;nbsp;&amp;nbsp; %uaquot&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; User agent <span class="keyword">with</span> format: &amp;quot;Mozilla/<span class="number">4.0</span> (compatible, ...)&amp;quot;

#&amp;nbsp;&amp;nbsp; %ua&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; User agent <span class="keyword">with</span> format: Mozilla/<span class="number">4.0</span>_(compatible...)

#&amp;nbsp;&amp;nbsp; %gzipin&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; mod_gzip compression input bytes: <span class="keyword">In</span>:XXX

#&amp;nbsp;&amp;nbsp; %gzipout&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; mod_gzip compression output bytes &amp;amp; ratio: <span class="keyword">Out</span>:YYY:ZZpct.

#&amp;nbsp;&amp;nbsp; %gzipratio&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; mod_gzip compression ratio: ZZpct.

#&amp;nbsp;&amp;nbsp; %deflateratio&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; mod_deflate compression ratio <span class="keyword">with</span> format: (ZZ)

#&amp;nbsp;&amp;nbsp; %email&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; EMail sender (<span class="keyword">for</span> mail log)

#&amp;nbsp;&amp;nbsp; %email_r&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; EMail receiver (<span class="keyword">for</span> mail log)

#&amp;nbsp;&amp;nbsp; %virtualname&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Web sever <span class="keyword">virtual</span> hostname. Use this tag when same log

#&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; contains data <span class="keyword">of</span> several <span class="keyword">virtual</span> web servers. AWStats

#&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; will discard records <span class="keyword">not</span> <span class="keyword">in</span> SiteDomain nor HostAliases

#&amp;nbsp;&amp;nbsp; %cluster&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; <span class="keyword">If</span> log file <span class="keyword">is</span> provided <span class="keyword">from</span> several computers (merged <span class="keyword">by</span>

#&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; logresolvemerge.pl), use this <span class="keyword">to</span> define cluster id field.

#&amp;nbsp;&amp;nbsp; %extraX&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Another field that you plan <span class="keyword">to</span> use <span class="keyword">for</span> building a

#&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; personalized report <span class="keyword">with</span> ExtraSection feature (See later).

#&amp;nbsp;&amp;nbsp; <span class="keyword">If</span> your log format <span class="keyword">has</span> some fields <span class="keyword">not</span> included <span class="keyword">in</span> this list, use:

#&amp;nbsp;&amp;nbsp; %other&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Means another <span class="keyword">not</span> used field

#&amp;nbsp;&amp;nbsp; %otherquot&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Means another <span class="keyword">not</span> used double quoted field
</code></pre><p>squid自定义字段说明：</p>
<pre><code>logformat &amp;lt;<span class="property">name</span>&amp;gt; &amp;lt;format specification&amp;gt;

&amp;nbsp;&amp;nbsp;&amp;nbsp; Defines an access <span class="command">log</span> format.

&amp;nbsp;&amp;nbsp;&amp;nbsp; The &amp;lt;format specification&amp;gt; <span class="keyword">is</span> a <span class="type">string</span> <span class="keyword">with</span> embedded % format codes

&amp;nbsp;&amp;nbsp;&amp;nbsp; % format codes all follow <span class="keyword">the</span> same basic structure <span class="keyword">where</span> all <span class="keyword">but</span>

&amp;nbsp;&amp;nbsp;&amp;nbsp; <span class="keyword">the</span> formatcode <span class="keyword">is</span> optional. Output strings are automatically escaped

&amp;nbsp;&amp;nbsp;&amp;nbsp; <span class="keyword">as</span> required according <span class="keyword">to</span> their context <span class="keyword">and</span> <span class="keyword">the</span> output format

&amp;nbsp;&amp;nbsp;&amp;nbsp; modifiers are usually <span class="keyword">not</span> needed, <span class="keyword">but</span> can be specified <span class="keyword">if</span> an explicit

&amp;nbsp;&amp;nbsp;&amp;nbsp; output format <span class="keyword">is</span> desired.

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; % [&amp;quot;|[|&amp;<span class="comment">#39;|#] [-] [[0]width] [{argument}] formatcode</span>

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;quot;&amp;nbsp;&amp;nbsp;&amp;nbsp; output <span class="keyword">in</span> quoted <span class="type">string</span> format

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [&amp;nbsp;&amp;nbsp;&amp;nbsp; output <span class="keyword">in</span> squid <span class="type">text</span> <span class="command">log</span> format <span class="keyword">as</span> used <span class="keyword">by</span> log_mime_hdrs

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; <span class="comment">#&amp;nbsp;&amp;nbsp;&amp;nbsp; output in URL quoted format</span>

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;<span class="comment">#39;&amp;nbsp;&amp;nbsp;&amp;nbsp; output as-is</span>

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; -&amp;nbsp;&amp;nbsp;&amp;nbsp; left aligned

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; width&amp;nbsp;&amp;nbsp;&amp;nbsp; field width. If starting <span class="keyword">with</span> <span class="number">0</span> <span class="keyword">the</span>

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; output <span class="keyword">is</span> zero padded

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; {arg}&amp;nbsp;&amp;nbsp;&amp;nbsp; argument such <span class="keyword">as</span> header <span class="property">name</span> etc

&amp;nbsp;&amp;nbsp;&amp;nbsp; Format codes:

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; %&amp;nbsp;&amp;nbsp;&amp;nbsp; a literal % <span class="property">character</span>

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; sn&amp;nbsp;&amp;nbsp;&amp;nbsp; Unique sequence <span class="type">number</span> per <span class="command">log</span> line entry

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; err_code&amp;nbsp;&amp;nbsp;&amp;nbsp; The ID <span class="keyword">of</span> an <span class="keyword">error</span> response served <span class="keyword">by</span> Squid <span class="keyword">or</span>

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; a similar internal <span class="keyword">error</span> identifier.

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; err_detail&amp;nbsp; Additional err_code-dependent <span class="keyword">error</span> information.

&amp;nbsp;&amp;nbsp;&amp;nbsp; Connection related format codes:

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;gt;a&amp;nbsp;&amp;nbsp;&amp;nbsp; Client source IP address

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;gt;A&amp;nbsp;&amp;nbsp;&amp;nbsp; Client FQDN

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;gt;p&amp;nbsp;&amp;nbsp;&amp;nbsp; Client source port

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;gt;eui&amp;nbsp;&amp;nbsp;&amp;nbsp; Client EUI (MAC address, EUI-<span class="number">48</span> <span class="keyword">or</span> EUI-<span class="number">64</span> identifier)

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;A&amp;nbsp;&amp;nbsp;&amp;nbsp; Server IP address <span class="keyword">or</span> peer <span class="property">name</span>

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; la&amp;nbsp;&amp;nbsp;&amp;nbsp; Local IP address (http_port)

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; lp&amp;nbsp;&amp;nbsp;&amp;nbsp; Local port <span class="type">number</span> (http_port)

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;la&amp;nbsp;&amp;nbsp;&amp;nbsp; Local IP address <span class="keyword">of</span> <span class="keyword">the</span> <span class="keyword">last</span> server <span class="keyword">or</span> peer connection

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;lp&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Local port <span class="type">number</span> <span class="keyword">of</span> <span class="keyword">the</span> <span class="keyword">last</span> server <span class="keyword">or</span> peer connection

&amp;nbsp;&amp;nbsp;&amp;nbsp; Time related format codes:

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; ts&amp;nbsp;&amp;nbsp;&amp;nbsp; Seconds <span class="keyword">since</span> epoch

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; tu&amp;nbsp;&amp;nbsp;&amp;nbsp; subsecond <span class="property">time</span> (milliseconds)

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; tl&amp;nbsp;&amp;nbsp;&amp;nbsp; Local <span class="property">time</span>. Optional strftime format argument

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; default %d/%b/%Y:%H:%M:%S %z

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; tg&amp;nbsp;&amp;nbsp;&amp;nbsp; GMT <span class="property">time</span>. Optional strftime format argument

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; default %d/%b/%Y:%H:%M:%S %z

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; tr&amp;nbsp;&amp;nbsp;&amp;nbsp; Response <span class="property">time</span> (milliseconds)

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; dt&amp;nbsp;&amp;nbsp;&amp;nbsp; Total <span class="property">time</span> spent making DNS lookups (milliseconds)

&amp;nbsp;&amp;nbsp;&amp;nbsp; HTTP cache related format codes:

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]&amp;gt;h&amp;nbsp;&amp;nbsp;&amp;nbsp; Original request header. Optional header <span class="property">name</span> argument

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> format header[:[separator]element]

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]&amp;gt;ha&amp;nbsp;&amp;nbsp;&amp;nbsp; The HTTP request headers <span class="keyword">after</span> adaptation <span class="keyword">and</span> redirection. 

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; Optional header <span class="property">name</span> argument <span class="keyword">as</span> <span class="keyword">for</span> &amp;gt;h

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]&amp;lt;h&amp;nbsp;&amp;nbsp;&amp;nbsp; Reply header. Optional header <span class="property">name</span> argument

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; <span class="keyword">as</span> <span class="keyword">for</span> &amp;gt;h

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]un&amp;nbsp;&amp;nbsp;&amp;nbsp; User <span class="property">name</span>

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]ul&amp;nbsp;&amp;nbsp;&amp;nbsp; User <span class="property">name</span> <span class="keyword">from</span> authentication

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]ui&amp;nbsp;&amp;nbsp;&amp;nbsp; User <span class="property">name</span> <span class="keyword">from</span> ident

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]us&amp;nbsp;&amp;nbsp;&amp;nbsp; User <span class="property">name</span> <span class="keyword">from</span> SSL

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]ue&amp;nbsp;&amp;nbsp;&amp;nbsp; User <span class="property">name</span> <span class="keyword">from</span> external acl helper

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]&amp;gt;Hs&amp;nbsp;&amp;nbsp;&amp;nbsp; HTTP status code sent <span class="keyword">to</span> <span class="keyword">the</span> client

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]&amp;lt;Hs&amp;nbsp;&amp;nbsp;&amp;nbsp; HTTP status code received <span class="keyword">from</span> <span class="keyword">the</span> next hop

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]&amp;lt;bs&amp;nbsp;&amp;nbsp;&amp;nbsp; Number <span class="keyword">of</span> HTTP-equivalent message body bytes 

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; received <span class="keyword">from</span> <span class="keyword">the</span> next hop, excluding chunked

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; transfer encoding <span class="keyword">and</span> control messages.

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; Generated FTP/Gopher listings are treated <span class="keyword">as</span>

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; received bodies.

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]Ss&amp;nbsp;&amp;nbsp;&amp;nbsp; Squid request status (TCP_MISS etc)

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]Sh&amp;nbsp;&amp;nbsp;&amp;nbsp; Squid hierarchy status (DEFAULT_PARENT etc)

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]mt&amp;nbsp;&amp;nbsp;&amp;nbsp; MIME content type

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]rm&amp;nbsp;&amp;nbsp;&amp;nbsp; Request method (GET/POST etc)

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]&amp;gt;rm&amp;nbsp;&amp;nbsp;&amp;nbsp; Request method <span class="keyword">from</span> client

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]&amp;lt;rm&amp;nbsp;&amp;nbsp;&amp;nbsp; Request method sent <span class="keyword">to</span> server <span class="keyword">or</span> peer

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]ru&amp;nbsp;&amp;nbsp;&amp;nbsp; Request URL <span class="keyword">from</span> client (historic, filtered <span class="keyword">for</span> logging)

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]&amp;gt;ru&amp;nbsp;&amp;nbsp;&amp;nbsp; Request URL <span class="keyword">from</span> client

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]&amp;lt;ru&amp;nbsp;&amp;nbsp;&amp;nbsp; Request URL sent <span class="keyword">to</span> server <span class="keyword">or</span> peer

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]rp&amp;nbsp;&amp;nbsp;&amp;nbsp; Request URL-Path excluding hostname

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]&amp;gt;rp&amp;nbsp;&amp;nbsp;&amp;nbsp; Request URL-Path excluding hostname <span class="keyword">from</span> client

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]&amp;lt;rp&amp;nbsp;&amp;nbsp;&amp;nbsp; Request URL-Path excluding hostname sento <span class="keyword">to</span> server <span class="keyword">or</span> peer

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]rv&amp;nbsp;&amp;nbsp;&amp;nbsp; Request protocol <span class="property">version</span>

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]&amp;gt;rv&amp;nbsp;&amp;nbsp;&amp;nbsp; Request protocol <span class="property">version</span> <span class="keyword">from</span> client

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]&amp;lt;rv&amp;nbsp;&amp;nbsp;&amp;nbsp; Request protocol <span class="property">version</span> sent <span class="keyword">to</span> server <span class="keyword">or</span> peer

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]et&amp;nbsp;&amp;nbsp;&amp;nbsp; Tag returned <span class="keyword">by</span> external acl

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]ea&amp;nbsp;&amp;nbsp;&amp;nbsp; Log <span class="type">string</span> returned <span class="keyword">by</span> external acl

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]&amp;lt;st&amp;nbsp;&amp;nbsp;&amp;nbsp; Sent reply size including HTTP headers

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]&amp;gt;st&amp;nbsp;&amp;nbsp;&amp;nbsp; Received request size including HTTP headers. In <span class="keyword">the</span>

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; case <span class="keyword">of</span> chunked requests <span class="keyword">the</span> chunked encoding metadata

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; are <span class="keyword">not</span> included

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]&amp;gt;sh&amp;nbsp;&amp;nbsp;&amp;nbsp; Received HTTP request headers size

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]&amp;lt;sh&amp;nbsp;&amp;nbsp;&amp;nbsp; Sent HTTP reply headers size

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]st&amp;nbsp;&amp;nbsp;&amp;nbsp; Request+Reply size including HTTP headers

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]&amp;lt;sH&amp;nbsp;&amp;nbsp;&amp;nbsp; Reply high <span class="command">offset</span> sent

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]&amp;lt;sS&amp;nbsp;&amp;nbsp;&amp;nbsp; Upstream object size

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]&amp;lt;pt&amp;nbsp;&amp;nbsp;&amp;nbsp; Peer response <span class="property">time</span> <span class="keyword">in</span> milliseconds. The timer starts

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; when <span class="keyword">the</span> <span class="keyword">last</span> request byte <span class="keyword">is</span> sent <span class="keyword">to</span> <span class="keyword">the</span> next hop

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; <span class="keyword">and</span> stops when <span class="keyword">the</span> <span class="keyword">last</span> response byte <span class="keyword">is</span> received.

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; [http::]&amp;lt;tt&amp;nbsp;&amp;nbsp;&amp;nbsp; Total server-side <span class="property">time</span> <span class="keyword">in</span> milliseconds. The timer 

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; <span class="keyword">starts with</span> <span class="keyword">the</span> <span class="keyword">first</span> connect request (<span class="keyword">or</span> <span class="command">write</span> I/O)

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; sent <span class="keyword">to</span> <span class="keyword">the</span> <span class="keyword">first</span> selected peer. The timer stops

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; <span class="keyword">with</span> <span class="keyword">the</span> <span class="keyword">last</span> I/O <span class="keyword">with</span> <span class="keyword">the</span> <span class="keyword">last</span> peer.

&amp;nbsp;&amp;nbsp;&amp;nbsp; If ICAP <span class="keyword">is</span> enabled, <span class="keyword">the</span> following code becomes available (<span class="keyword">as</span>

&amp;nbsp;&amp;nbsp;&amp;nbsp; well <span class="keyword">as</span> ICAP <span class="command">log</span> codes documented <span class="keyword">with</span> <span class="keyword">the</span> icap_log option):

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; icap::tt&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Total ICAP processing <span class="property">time</span> <span class="keyword">for</span> <span class="keyword">the</span> HTTP

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; <span class="keyword">transaction</span>. The timer ticks when ICAP

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; ACLs are checked <span class="keyword">and</span> when ICAP

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; <span class="keyword">transaction</span> <span class="keyword">is</span> <span class="keyword">in</span> progress.

&amp;nbsp;&amp;nbsp;&amp;nbsp; If adaptation <span class="keyword">is</span> enabled <span class="keyword">the</span> following three codes become available:

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; adapt::&amp;lt;last_h&amp;nbsp;&amp;nbsp;&amp;nbsp; The header <span class="keyword">of</span> <span class="keyword">the</span> <span class="keyword">last</span> ICAP response <span class="keyword">or</span>

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; meta-information <span class="keyword">from</span> <span class="keyword">the</span> <span class="keyword">last</span> eCAP

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; <span class="keyword">transaction</span> related <span class="keyword">to</span> <span class="keyword">the</span> HTTP <span class="keyword">transaction</span>.

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; Like &amp;lt;h, accepts an optional header <span class="property">name</span>

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; argument.

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; adapt::sum_trs Summed adaptation <span class="keyword">transaction</span> response

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; <span class="keyword">times</span> recorded <span class="keyword">as</span> a comma-separated <span class="type">list</span> <span class="keyword">in</span>

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; <span class="keyword">the</span> order <span class="keyword">of</span> <span class="keyword">transaction</span> start <span class="property">time</span>. Each <span class="property">time</span>

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; value <span class="keyword">is</span> recorded <span class="keyword">as</span> an <span class="type">integer</span> <span class="type">number</span>,

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; representing response <span class="property">time</span> <span class="keyword">of</span> one <span class="keyword">or</span> more

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; adaptation (ICAP <span class="keyword">or</span> eCAP) <span class="keyword">transaction</span> <span class="keyword">in</span>

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; milliseconds.&amp;nbsp; When a failed <span class="keyword">transaction</span> <span class="keyword">is</span>

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; being retried <span class="keyword">or</span> repeated, <span class="keyword">its</span> <span class="property">time</span> <span class="keyword">is</span> <span class="keyword">not</span>

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; logged individually <span class="keyword">but</span> added <span class="keyword">to</span> <span class="keyword">the</span>

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; replacement (next) <span class="keyword">transaction</span>. See also:

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; adapt::all_trs.

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; adapt::all_trs All adaptation <span class="keyword">transaction</span> response <span class="keyword">times</span>.

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; Same <span class="keyword">as</span> adaptation_strs <span class="keyword">but</span> response <span class="keyword">times</span> <span class="keyword">of</span>

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; individual transactions are never added

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; together. Instead, all <span class="keyword">transaction</span> response

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; <span class="keyword">times</span> are recorded individually.

&amp;nbsp;&amp;nbsp;&amp;nbsp; You can prefix adapt::*_trs format codes <span class="keyword">with</span> adaptation

&amp;nbsp;&amp;nbsp;&amp;nbsp; service <span class="property">name</span> <span class="keyword">in</span> curly braces <span class="keyword">to</span> <span class="type">record</span> response <span class="property">time</span>(s) specific

&amp;nbsp;&amp;nbsp;&amp;nbsp; <span class="keyword">to</span> <span class="keyword">that</span> service. For example: %{my_service}adapt::sum_trs

&amp;nbsp;&amp;nbsp;&amp;nbsp; The default formats available (which do <span class="keyword">not</span> need re-defining) are:

logformat squid&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; %ts.%<span class="number">03</span>tu %<span class="number">6</span>tr %&amp;gt;a %Ss/%<span class="number">03</span>&amp;gt;Hs %&amp;lt;st %rm %ru %un %Sh/%&amp;lt;A %mt

logformat common&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; %&amp;gt;a %ui %un [%tl] &amp;quot;%rm %ru HTTP/%rv&amp;quot; %&amp;gt;Hs %&amp;lt;st %Ss:%Sh

logformat combined&amp;nbsp;&amp;nbsp; %&amp;gt;a %ui %un [%tl] &amp;quot;%rm %ru HTTP/%rv&amp;quot; %&amp;gt;Hs %&amp;lt;st &amp;quot;%{Referer}&amp;gt;h&amp;quot; &amp;quot;%{User-Agent}&amp;gt;h&amp;quot; %Ss:%Sh

logformat referrer&amp;nbsp;&amp;nbsp; %ts.%<span class="number">03</span>tu %&amp;gt;a %{Referer}&amp;gt;h %ru

logformat useragent&amp;nbsp; %&amp;gt;a [%tl] &amp;quot;%{User-Agent}&amp;gt;h&amp;quot;

&amp;nbsp;&amp;nbsp;&amp;nbsp; When <span class="keyword">the</span> log_mime_hdrs directive <span class="keyword">is</span> <span class="keyword">set</span> <span class="keyword">to</span> ON. The squid, common <span class="keyword">and</span> combined

&amp;nbsp;&amp;nbsp;&amp;nbsp; formats have a safely encoded <span class="keyword">copy</span> <span class="keyword">of</span> <span class="keyword">the</span> mime headers appended <span class="keyword">to</span> each line

&amp;nbsp;&amp;nbsp;&amp;nbsp; within a pair <span class="keyword">of</span> brackets.

&amp;nbsp;&amp;nbsp;&amp;nbsp; The common <span class="keyword">and</span> combined formats are <span class="keyword">not</span> quite <span class="constant">true</span> <span class="keyword">to</span> <span class="keyword">the</span> Apache definition.

&amp;nbsp;&amp;nbsp;&amp;nbsp; The logs <span class="keyword">from</span> Squid <span class="keyword">contain</span> an extra status <span class="keyword">and</span> hierarchy code appended.
</code></pre></div><footer class="post__foot u-cf"><a href="/2011/07/11/w/awstats-e5-88-86-e6-9e-90-e7-bb-9f-e8-ae-a1squid-e6-97-a5-e5-bf-97/#comments" class="post__foot-link u-fr">评论</a></footer></article><article class="post"><header class="post__head"><time datetime="2011-06-24T02:51:04.000Z" class="post__time">六月 24, 2011</time><h1 class="post__title"><a href="/2011/06/24/w/e9-82-ae-e4-bb-b6-e7-b3-bb-e7-bb-9f-e7-bb-b4-e6-8a-a4-e7-9a-84-e5-b8-b8-e7-94-a8-e5-91-bd-e4-bb-a4/">邮件系统维护的常用命令</a></h1></header><div class="post__main"><p>查找发信最多的用户，如果账户被盗用，通常一天会发送成千上万封邮件</p>
<p>gzip -cd maillog.1.gz |grep &quot;from=&quot;|cut -f 7 -d &quot; &quot;|cut -f 2 -d &quot;&lt;&quot;|sed &#39;s/&gt;,//g&#39;|sed &#39;/^$/d&#39;|grep &quot;@&quot;|awk -F&quot;:&quot; &#39;{++S[$(NF-1)]} END{for(a in S) print a, S[a]}&#39;|sort -n -k 2|less</p>
<p>查找发现最多的ip：</p>
<p>cat maillog.1|grep &quot; connect from&quot;|cut -f 8 -d &quot; &quot;|cut -f 2 -d &quot;[“|sed ‘s/]//g’|awk -F”:” ‘{++S[$(NF-1)]} END{for(a in S) print a, S[a]}&#39;|sort -n -k 2|less</p>
<p>监控实时日志</p>
<p>tail -f /var/log/mail/maillog|grep -v pop3|grep -v &quot;User unknown&quot;|grep -v &quot;Connection timed out&quot;|grep -v &quot;Host not found&quot;</p>
<p>清空邮件队列（慎用）：</p>
<p>postsuper -d ALL</p>
<p>删除队列中某个用户的邮件：</p>
<p>mailq | awk &#39;BEGIN { RS = &quot;&quot; } /nathalie.gervais@foo.com/ { print $1 }&#39; | tr -d &#39;*!&#39;| postsuper -d</p>
</div><footer class="post__foot u-cf"><a href="/2011/06/24/w/e9-82-ae-e4-bb-b6-e7-b3-bb-e7-bb-9f-e7-bb-b4-e6-8a-a4-e7-9a-84-e5-b8-b8-e7-94-a8-e5-91-bd-e4-bb-a4/#comments" class="post__foot-link u-fr">评论</a></footer></article><article class="post"><header class="post__head"><time datetime="2011-06-21T08:50:41.000Z" class="post__time">六月 21, 2011</time><h1 class="post__title"><a href="/2011/06/21/w/apachenginx-e9-85-8d-e7-bd-ae-cache-last-modified-e3-80-81expires/">Apache/Nginx 配置 Cache Last-Modified、Expires</a></h1></header><div class="post__main"><p>正确使用Expires标识处理，可以使得页面更加有效被缓冲，节约带宽资源。</p>
<pre><code>apache配置：

&amp;lt;IfModule mod_expires.c&amp;gt;

&amp;nbsp;&amp;nbsp;&amp;nbsp; ExpiresActive On

&amp;nbsp;&amp;nbsp;&amp;nbsp; ExpiresByType image/gif A2592000

&amp;nbsp;&amp;nbsp;&amp;nbsp; ExpiresByType image/jpeg A2592000

&amp;nbsp;&amp;nbsp;&amp;nbsp; ExpiresByType image/png A2592000

&amp;nbsp;&amp;nbsp;&amp;nbsp; ExpiresByType image/x-icon A2592000

&amp;nbsp;&amp;nbsp;&amp;nbsp; ExpiresByType application/x-javascript A604800

&amp;nbsp;&amp;nbsp;&amp;nbsp; ExpiresByType text/css A604800

&amp;lt;/IfModule&amp;gt;

或者

&amp;lt;ifmodule mod_expires.c&amp;gt;

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;filesmatch &amp;quot;\.(jpg|gif|png|css|js)$&amp;quot;&amp;gt;

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ExpiresActive on

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ExpiresDefault &amp;quot;access plus 600 minutes&amp;quot;

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;/filesmatch&amp;gt;

&amp;lt;/ifmodule&amp;gt;

可以选用的时间参数有years&amp;nbsp;&amp;nbsp;&amp;nbsp; months&amp;nbsp;&amp;nbsp;&amp;nbsp; weeks&amp;nbsp;&amp;nbsp;&amp;nbsp; days&amp;nbsp;&amp;nbsp;&amp;nbsp; hours&amp;nbsp;&amp;nbsp;&amp;nbsp; minutes&amp;nbsp;&amp;nbsp;&amp;nbsp; seconds

也可以加在.htaccess文件：

#Expire Header

&amp;lt;FilesMatch &amp;quot;\.(ico|jpg|jpeg|png|gif|js|css|swf)$&amp;quot;&amp;gt;

&amp;nbsp;&amp;nbsp;&amp;nbsp; ExpiresDefault &amp;quot;access plus 2 hours&amp;quot;

&amp;lt;/FilesMatch&amp;gt;

or

# Expire images header

ExpiresActive On

ExpiresDefault A0

ExpiresByType image/gif A2592000

ExpiresByType image/png A2592000

ExpiresByType image/jpg A2592000

ExpiresByType image/jpeg A2592000

ExpiresByType image/ico A2592000

ExpiresByType text/css A2592000

ExpiresByType text/javascript A2592000

#A2592000 means 1 month in the future (60*60*24*30=2592000)

nginx配置：

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; location ~* ^.+\.(jpg|jpeg|gif|png|swf|rar|zip|css|js|flv|mp3|wma|wmv|ram|rm)$ {

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; valid_referers none blocked *.veryi.com;

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; if ($invalid_referer) {

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; #rewrite ^/ http://veryi.com/cloud.gif;

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; #return 412;

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; return 403;

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; }

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; access_log off;

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; root /opt/www;

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; expires 10h;

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; break;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }

或者&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; location ~ \.(gif|jpg|png|swf|flv|bmp)$ {

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; valid_referers none blocked *.veryi.com;

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if ($invalid_referer) {

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; #rewrite ^/ http://www.veryi.com/403.JPG;

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; return 403;

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; expires&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 30d;

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; location ~ .*\.(js|css)?$

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; {

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; expires&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 3d;

&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; } 

测试：

curl -I http://veryi.com/w/wp-content/uploads/%E5%A7%9C%E5%8C%BB%E5%B8%88.gif

HTTP/1.1 200 OK

Server: Apache/2.0.63

Date: Tue, 21 Jun 2011 08:13:06 GMT

Content-Type: image/gif

Content-Length: 21734

Last-Modified: Tue, 21 Jun 2011 08:11:00 GMT

Connection: keep-alive

Expires: Thu, 21 Jul 2011 08:13:06 GMT

<span class="operator"><span class="keyword">Cache</span>-Control: <span class="keyword">max</span>-age=<span class="number">2592000</span>

Accept-Ranges: bytes

Etag和Expires的工作原理

http://www.neil.tk/archives/<span class="number">12</span>

在客户端通过浏览器发出第一次请求某一个URL时，根据 HTTP 协议的规定，浏览器会向服务器传送报头(Http Request Header)，服务器端响应同时记录相关属性标记(Http Reponse Header)，服务器端的返回状态会是<span class="number">200</span>，格式类似如下：

HTTP/<span class="number">1.1</span> <span class="number">200</span> OK

<span class="built_in">Date</span>: Tue, <span class="number">03</span> Mar <span class="number">2009</span> <span class="number">04</span>:<span class="number">58</span>:<span class="number">40</span> GMT

Content-Type: image/jpeg

Content-Length: <span class="number">83185</span>

<span class="keyword">Last</span>-Modified: Tue, <span class="number">24</span> Feb <span class="number">2009</span> <span class="number">08</span>:<span class="number">01</span>:<span class="number">04</span> GMT

<span class="keyword">Cache</span>-Control: <span class="keyword">max</span>-age=<span class="number">2592000</span>

Expires: Thu, <span class="number">02</span> Apr <span class="number">2009</span> <span class="number">05</span>:<span class="number">14</span>:<span class="number">08</span> GMT

Etag: &amp;ldquo;</span>5d8c72a5edda8d6a:3239&amp;Prime;

客户端第二次请求此URL时，根据 HTTP 协议的规定，浏览器会向服务器传送报头(Http Request Header)，服务器端响应并记录相关记录属性标记文件没有发生改动,服务器端返回304，直接从缓存中读取：

HTTP/1.x 304 Not Modified

Date: Tue, 03 Mar 2009 05:03:56 GMT

Content-Type: image/jpeg

Content-Length: 83185

Last-Modified: Tue, 24 Feb 2009 08:01:04 GMT

<span class="operator"><span class="keyword">Cache</span>-Control: <span class="keyword">max</span>-age=<span class="number">2592000</span>

Expires: Thu, <span class="number">02</span> Apr <span class="number">2009</span> <span class="number">05</span>:<span class="number">14</span>:<span class="number">08</span> GMT

Etag: &amp;ldquo;</span>5d8c72a5edda8d6a:3239&amp;Prime;

其中Last-Modified、Expires和Etag是标记页面缓存标识

一、Last-Modified、Expires和Etag相关工作原理

1、Last-Modified

在浏览器第一次请求某一个URL时，服务器端的返回状态会是200，内容是你请求的资源，同时有一个Last-Modified的属性标记(Http Reponse Header)此文件在服务期端最后被修改的时间，格式类似这样：

Last-Modified: Tue, 24 Feb 2009 08:01:04 GMT

客户端第二次请求此URL时，根据 HTTP 协议的规定，浏览器会向服务器传送 If-Modified-Since 报头(Http Request Header)，询问该时间之后文件是否有被修改过：

If-Modified-Since: Tue, 24 Feb 2009 08:01:04 GMT

如果服务器端的资源没有变化，则自动返回 HTTP 304 （Not Changed.）状态码，内容为空，这样就节省了传输数据量。当服务器端代码发生改变或者重启服务器时，则重新发出资源，返回和第一次请求时类似。从而保证不向客户端重复发出资源，也保证当服务器有变化时，客户端能够得到最新的资源。

注：如果If-Modified-Since的时间比服务器当前时间(当前的请求时间request_time)还晚，会认为是个非法请求

2、Etag工作原理

HTTP 协议规格说明定义ETag为&amp;ldquo;被请求变量的实体标记&amp;rdquo; （参见14.19）。简单点即服务器响应时给请求URL标记，并在HTTP响应头中将其传送到客户端，类似服务器端返回的格式：

Etag: &amp;ldquo;5d8c72a5edda8d6a:3239&amp;Prime;

客户端的查询更新格式是这样的：

If-None-Match: &amp;ldquo;5d8c72a5edda8d6a:3239&amp;Prime;

如果ETag没改变，则返回状态304。

即:在客户端发出请求后，Http Reponse Header中包含 Etag: &amp;ldquo;5d8c72a5edda8d6a:3239&amp;Prime;

标识，等于告诉Client端，你拿到的这个的资源有表示ID：5d8c72a5edda8d6a:3239。当下次需要发Request索要同一个URI的时候，浏览器同时发出一个If-None-Match报头( Http Request Header)此时包头中信息包含上次访问得到的Etag: &amp;ldquo;5d8c72a5edda8d6a:3239&amp;Prime;标识。

If-None-Match: &amp;ldquo;5d8c72a5edda8d6a:3239&amp;ldquo;

,这样，Client端等于<span class="operator"><span class="keyword">Cache</span>了两份，服务器端就会比对<span class="number">2</span>者的etag。如果<span class="keyword">If</span>-None-<span class="keyword">Match</span>为<span class="literal">False</span>，不返回<span class="number">200</span>，返回<span class="number">304</span> (<span class="keyword">Not</span> Modified) Response。

<span class="number">3</span>、Expires

给出的日期/时间后，被响应认为是过时。如Expires: Thu, <span class="number">02</span> Apr <span class="number">2009</span> <span class="number">05</span>:<span class="number">14</span>:<span class="number">08</span> GMT

需和<span class="keyword">Last</span>-Modified结合使用。用于控制请求文件的有效时间，当请求数据在有效期内时客户端浏览器从缓存请求数据而不是服务器端. 当缓存中数据失效或过期，才决定从服务器更新数据。

<span class="number">4</span>、<span class="keyword">Last</span>-Modified和Expires

<span class="keyword">Last</span>-Modified标识能够节省一点带宽，但是还是逃不掉发一个HTTP请求出去，而且要和Expires一起用。而Expires标识却使得浏览器干脆连HTTP请求都不用发，比如当用户F5或者点击Refresh按钮的时候就算对于有Expires的URI，一样也会发一个HTTP请求出去，所以，<span class="keyword">Last</span>-Modified还是要用的，而 且要和Expires一起用。

<span class="number">5</span>、Etag和Expires

如果服务器端同时设置了Etag和Expires时，Etag原理同样，即与<span class="keyword">Last</span>-Modified/Etag对应的Http Request Header:<span class="keyword">If</span>-Modified-Since和<span class="keyword">If</span>-None-<span class="keyword">Match</span>。我们可以看到这两个Header的值和Web <span class="keyword">Server</span>发出的<span class="keyword">Last</span>-Modified,Etag值完全一样；在完全匹配<span class="keyword">If</span>-Modified-Since和<span class="keyword">If</span>-None-<span class="keyword">Match</span>即检查完修改时间和Etag之后，服务器才能返回<span class="number">304.</span>

<span class="number">6</span>、<span class="keyword">Last</span>-Modified和Etag

<span class="keyword">Last</span>-Modified 和ETags请求的http报头一起使用，服务器首先产生 <span class="keyword">Last</span>-Modified/Etag标记，服务器可在稍后使用它来判断页面是否已经被修改，来决定文件是否继续缓存

过程如下:

<span class="number">1</span>\. 客户端请求一个页面（A）。

<span class="number">2</span>\. 服务器返回页面A，并在给A加上一个<span class="keyword">Last</span>-Modified/ETag。

<span class="number">3</span>\. 客户端展现该页面，并将页面连同<span class="keyword">Last</span>-Modified/ETag一起缓存。

<span class="number">4</span>\. 客户再次请求页面A，并将上次请求时服务器返回的<span class="keyword">Last</span>-Modified/ETag一起传递给服务器。

<span class="number">5</span>\. 服务器检查该<span class="keyword">Last</span>-Modified或ETag，并判断出该页面自上次客户端请求之后还未被修改，直接返回响应<span class="number">304</span>和一个空的响应体。

注：

<span class="number">1</span>、<span class="keyword">Last</span>-Modified和Etag头都是由Web <span class="keyword">Server</span>发出的Http Reponse Header，Web <span class="keyword">Server</span>应该同时支持这两种头。

<span class="number">2</span>、Web <span class="keyword">Server</span>发送完<span class="keyword">Last</span>-Modified/Etag头给客户端后，客户端会缓存这些头；

<span class="number">3</span>、客户端再次发起相同页面的请求时，将分别发送与<span class="keyword">Last</span>-Modified/Etag对应的Http Request Header:<span class="keyword">If</span>-Modified-Since和<span class="keyword">If</span>-None-<span class="keyword">Match</span>。我们可以看到这两个Header的值和Web <span class="keyword">Server</span>发出的<span class="keyword">Last</span>-Modified,Etag值完全一样；

<span class="number">4</span>、通过上述值到服务器端检查，判断文件是否继续缓存；

在客户端通过浏览器发出第一次请求某一个URL时，根据 HTTP 协议的规定，浏览器会向服务器传送报头(Http Request Header)，服务器端响应同时记录相关属性标记(Http Reponse Header)，服务器端的返回状态会是<span class="number">200</span>，格式类似如下：

HTTP/<span class="number">1.1</span> <span class="number">200</span> OK

客户端第二次请求此URL时，根据 HTTP 协议的规定，浏览器会向服务器传送报头(Http Request Header)，服务器端响应并记录相关记录属性标记文件没有发生改动,服务器端返回<span class="number">304</span>，直接从缓存中读取：

HTTP/<span class="number">1.</span>x <span class="number">304</span> <span class="keyword">Not</span> Modified

其中<span class="keyword">Last</span>-Modified、Expires和Etag是标记页面缓存标识

一、<span class="keyword">Last</span>-Modified、Expires和Etag相关工作原理

<span class="number">1</span>、<span class="keyword">Last</span>-Modified

在浏览器第一次请求某一个URL时，服务器端的返回状态会是<span class="number">200</span>，内容是你请求的资源，同时有一个<span class="keyword">Last</span>-Modified的属性标记 (Http Reponse Header)此文件在服务期端最后被修改的时间，格式类似这样：

<span class="keyword">Last</span>-Modified: 

客户端第二次请求此URL时，根据 HTTP 协议的规定，浏览器会向服务器传送 <span class="keyword">If</span>-Modified-Since 报头(Http Request Header)，询问该时间之后文件是否有被修改过：

<span class="keyword">If</span>-Modified-Since: 

如果服务器端的资源没有变化，则自动返回 HTTP <span class="number">304</span> （NotChanged.）状态码，内容为空，这样就节省了传输数据量。当服务器端代码发生改变或者重启服务器时，则重新发出资源，返回和第一次请求时类 似。从而保证不向客户端重复发出资源，也保证当服务器有变化时，客户端能够得到最新的资源。

注：如果<span class="keyword">If</span>-Modified-Since的时间比服务器当前时间(当前的请求时间request_time)还晚，会认为是个非法请求

<span class="number">2</span>、Etag工作原理

HTTP 协议规格说明定义ETag为&amp;rdquo;</span>被请求变量的实体标记&amp;rdquo; 。简单点即服务器响应时给请求URL标记，并在HTTP响应头中将其传送到客户端，类似服务器端返回的格式：

Etag: 

客户端的查询更新格式是这样的：

If-None-Match: 

如果ETag没改变，则返回状态304。

即:在客户端发出请求 后，Http Reponse Header中包含 Etag标识，等于告诉Client端，你拿到的这个的资源有表示 ID。当下次需要发Request索要同一个 URI的时候，浏览器同时发出一个If-None-Match报头( Http RequestHeader)此时包头中信息包含上次访问得到的Etag标识。

If-None-Match: &amp;quot;xok.la-961AA72-4CEA99B4415628&amp;quot;

,这样，Client端等于<span class="operator"><span class="keyword">Cache</span>了两份，服务器端就会比对<span class="number">2</span>者的etag。如果<span class="keyword">If</span>- None-<span class="keyword">Match</span>为<span class="literal">False</span>，不返回<span class="number">200</span>，返回<span class="number">304</span> (<span class="keyword">Not</span> Modified) Response。

<span class="number">3</span>、Expires

给出的 日期/时间后，被响应认为是过时。如Expires: Thu, <span class="number">02</span> Apr <span class="number">2009</span> <span class="number">05</span>:<span class="number">14</span>:<span class="number">08</span> GMT

需和<span class="keyword">Last</span>-Modified结合使用。用于控制请求文件的有效时间，当请求数据在有效期内时客 户端浏览器从缓存请求数据而不是服务器端. 当缓存中数据失效或过期，才决定从服务器更新数据。

<span class="number">4</span>、<span class="keyword">Last</span>-Modified和Expires

<span class="keyword">Last</span>- Modified标识能够节省一点带宽，但是还是逃不掉发一个HTTP请求出去，而且要和Expires一起用。而Expires标识却使得浏览器干脆连 HTTP请求都不用发，比如当用户F5或者点击Refresh按钮的时候就算对于有Expires的URI，一样也会发一个HTTP请求出去，所 以，<span class="keyword">Last</span>-Modified还是要用的，而 且要和Expires一起用。

<span class="number">5</span>、 Etag和Expires

如果服务器端同时设置了Etag和Expires 时，Etag原理同样，即与<span class="keyword">Last</span>-Modified/Etag对应的HttpRequest Header:<span class="keyword">If</span>-Modified-Since和<span class="keyword">If</span>-None-<span class="keyword">Match</span>。我们可以看到这两个Header的值和WebServer发出的 <span class="keyword">Last</span>-Modified,Etag值完全一样；在完全匹配<span class="keyword">If</span>-Modified-Since和<span class="keyword">If</span>-None-<span class="keyword">Match</span>即检查完修改时间和 Etag之后，服务器才能返回<span class="number">304.</span>

<span class="number">6</span>、<span class="keyword">Last</span>-Modified和Etag

<span class="keyword">Last</span>-Modified 和ETags请求的http报头一起使用，服务器首先产生 <span class="keyword">Last</span>-Modified/Etag标记，服务器可在稍后使用它来判断页面是否已经被修改，来决定文件是否继续缓存

过程如下:

<span class="number">1</span>\. 客户端请求一个页面（A）。

<span class="number">2</span>\. 服务器返回页面A，并在给A加上一个<span class="keyword">Last</span>-Modified/ETag。

<span class="number">3</span>\. 客户端展现该页面，并将页面连同<span class="keyword">Last</span>-Modified/ETag一起缓存。

<span class="number">4</span>\. 客户再次请求页面A，并将上次请求时服务器返回的<span class="keyword">Last</span>-Modified/ETag一起传递给服务器。

<span class="number">5</span>\. 服务器检查该<span class="keyword">Last</span>-Modified或ETag，并判断出该页面自上次客户端请求之后还未被修改，直接返回响应<span class="number">304</span>和一个空的响应体。

注：

<span class="number">1</span>、<span class="keyword">Last</span>- Modified和Etag头都是由Web <span class="keyword">Server</span>发出的Http Reponse Header，Web <span class="keyword">Server</span>应该同时支持这两种头。

<span class="number">2</span>、Web <span class="keyword">Server</span>发送完<span class="keyword">Last</span>-Modified/Etag头给客户端后，客户端会缓存这些头；

<span class="number">3</span>、客户端再次发起相同页面的请求时，将分别发送与<span class="keyword">Last</span>-Modified/Etag对应的Http RequestHeader:<span class="keyword">If</span>-Modified-Since和<span class="keyword">If</span>-None-<span class="keyword">Match</span>。我们可以看到这两个Header的值和 WebServer发出的<span class="keyword">Last</span>-Modified,Etag值完全一样；

<span class="number">4</span>、 通过上述值到服务器端检查，判断文件是否继续缓存；

二、Apache、 Lighttpd和Nginx中针配置Etag和Expires，有效缓存纯静态如css/js/pic/页面/流媒体等文件。

A、Expires

A<span class="number">.1</span>、 Apache Etag

使用Apache的mod_expires 模块来设置，这包括控制应答时的Expires头内容和<span class="keyword">Cache</span>-Control头的<span class="keyword">max</span>-age指令

ExpiresActive <span class="keyword">On</span>

ExpiresByType image/gif &amp;quot;</span>access plus 1 month&amp;quot;

ExpiresByType image/jpg &amp;quot;access plus 1 month&amp;quot;

ExpiresByType image/jpeg &amp;quot;access plus 1 month&amp;quot;

ExpiresByType image/x-icon &amp;quot;access plus 1 month&amp;quot;

ExpiresByType image/bmp &amp;quot;access plus 1 month&amp;quot;

ExpiresByType image/png &amp;quot;access plus 1 month&amp;quot;

ExpiresByType text/html &amp;quot;access plus 30 minutes&amp;quot;

ExpiresByType text/css&amp;nbsp; &amp;quot;access plus 30 minutes&amp;quot;

ExpiresByType text/txt&amp;nbsp; &amp;quot;access plus 30 minutes&amp;quot;

ExpiresByType text/js&amp;nbsp;&amp;nbsp; &amp;quot;access plus 30 minutes&amp;quot;

ExpiresByType application/x-javascript&amp;nbsp;&amp;nbsp; &amp;quot;access plus 30 minutes&amp;quot;

ExpiresByType application/x-shockwave-flash&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;quot;access plus 30 minutes&amp;quot;

或

&amp;lt;ifmodule mod_expires.c&amp;gt;

&amp;lt;filesmatch &amp;quot;\.(jpg|gif|png|css|js)$&amp;quot;&amp;gt;

ExpiresActive on

ExpiresDefault &amp;quot;access plus 1 year&amp;quot;

&amp;lt;/filesmatch&amp;gt;

&amp;lt;/ifmodule&amp;gt;

当设置了expires后，会自动输出<span class="operator"><span class="keyword">Cache</span>-Control 的<span class="keyword">max</span>-age 信息

具体关于 Expires 详细内容可以查看Apache官方文档。

在这个时间段里，该文件的请求都将直接通过缓存服务器获取，

当然如果需要忽略浏览器的刷新请求（F5)，缓存服务器squid还需要使用 refresh_pattern 选项来忽略该请求

refresh_pattern -i \.gif$ <span class="number">1440</span> <span class="number">100</span>% <span class="number">28800</span> <span class="keyword">ignore</span>-reload

refresh_pattern -i \.jpg$ <span class="number">1440</span> <span class="number">100</span>% <span class="number">28800</span> <span class="keyword">ignore</span>-reload

refresh_pattern -i \.jpeg$ <span class="number">1440</span> <span class="number">100</span>% <span class="number">28800</span> <span class="keyword">ignore</span>-reload

refresh_pattern -i \.png$ <span class="number">1440</span> <span class="number">100</span>% <span class="number">28800</span> <span class="keyword">ignore</span>-reload

refresh_pattern -i \.bmp$ <span class="number">1440</span> <span class="number">100</span>% <span class="number">28800</span> <span class="keyword">ignore</span>-reload

refresh_pattern -i \.htm$ <span class="number">60</span> <span class="number">100</span>% <span class="number">100</span> <span class="keyword">ignore</span>-reload

refresh_pattern -i \.html$ <span class="number">1440</span> <span class="number">50</span>% <span class="number">28800</span> <span class="keyword">ignore</span>-reload

refresh_pattern -i \.<span class="keyword">xml</span>$ <span class="number">1440</span> <span class="number">50</span>% <span class="number">28800</span> <span class="keyword">ignore</span>-reload

refresh_pattern -i \.txt$ <span class="number">1440</span> <span class="number">50</span>% <span class="number">28800</span> <span class="keyword">ignore</span>-reload

refresh_pattern -i \.css$ <span class="number">1440</span> <span class="number">50</span>% <span class="number">28800</span> reload-<span class="keyword">into</span>-ims

refresh_pattern -i \.js$ <span class="number">60</span> <span class="number">50</span>% <span class="number">100</span> reload-<span class="keyword">into</span>-ims

refresh_pattern . <span class="number">10</span> <span class="number">50</span>% <span class="number">60</span>

有关Squid中Expires的说明，请参考Squid官方中refresh_pattern介 绍。

A<span class="number">.2</span>、Lighttpd Expires

和Apache一样Lighttpd设置expire也要先查看是否支持了mod_expire模 块，

下面的设置是让URI中所有images目录下的文件<span class="number">1</span>小时后过期；

expire.url = ( &amp;quot;</span>/images/&amp;quot; =&amp;gt; &amp;quot;access 1 hours&amp;quot; )

下面是让作用于images目录及其子目录的文件；

$HTTP[&amp;quot;url&amp;quot;] =~ &amp;quot;^/images/&amp;quot; {

&amp;nbsp;

expire.url = ( &amp;quot;&amp;quot; =&amp;gt; &amp;quot;access 1 hours&amp;quot; )

&amp;nbsp;

}

也可以指定文件的类型；

$HTTP[&amp;quot;url&amp;quot;] =~ &amp;quot;\.(jpg|gif|png|css|js)$&amp;quot; {

&amp;nbsp;

expire.url = ( &amp;quot;&amp;quot; =&amp;gt; &amp;quot;access 1 hours&amp;quot; )

&amp;nbsp;

}

具体参考Lighttpd官方Expires解释

A.3、Nginx中Expireslocation ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$

{

expires 30d;

}

location ~ .*\.(js|css)?$

{

expires 1h;

}

这类文件并不常修改，通过 expires 指令来控制其在浏览器的缓存，以减少不必要的请求。 expires 指令可以控制 HTTP 应答中的&amp;rdquo; Expires &amp;ldquo;和&amp;rdquo; <span class="operator"><span class="keyword">Cache</span>-Control &amp;ldquo;</span>的头标（起到控制页面缓存的作用）。其他请参考Nginx中Expires

B.1、Apache中Etag设置

在Apache中设置Etag的支持比较简单，只用在含有静态文件的目录中建立一个文件.htaccess, 里面加入：

FileETag MTime Size

这样就行了，详细的可以参考Apache的FileEtag文档页

B.2、 Lighttpd Etag

在Lighttpd中设置Etag支持：

etag.use-inode: 是否使用inode作为Etag

etag.use-mtime: 是否使用文件修改时间作为Etag

etag.use-size: 是否使用文件大小作为Etag

static-file.etags: 是否启用Etag的功能

第四个参数肯定是要enable的， 前面三个就看实际的需要来选吧，推荐使用修改时间

B.3、 Nginx Etag

Nginx中默认没有添加对Etag标识.Igor Sysoev的观点&amp;rdquo;在对静态文件处理上看不出如何Etag好于Last-Modified标识。&amp;rdquo;

Note:

Yes, it&amp;#39;s addition,and it&amp;#39;s easy to add, however, I <span class="operator"><span class="keyword">do</span> <span class="keyword">not</span> see howETag <span class="keyword">is</span> better than <span class="keyword">Last</span>-Modified <span class="keyword">for</span> static files. -Igor Sysoev

A nice short description <span class="keyword">is</span> here:

http://www.mnot.net/cache_docs/#<span class="keyword">WORK</span>

It looks <span class="keyword">to</span> me that it makes <span class="keyword">some</span> caches out there <span class="keyword">to</span> <span class="keyword">cache</span> theresponse <span class="keyword">from</span> the origin <span class="keyword">server</span> more reliable <span class="keyword">as</span> <span class="keyword">in</span> rfc2616(ftp://ftp.rfc-editor.org/<span class="keyword">in</span>-notes/rfc2616.txt) <span class="keyword">is</span> written.

<span class="number">3.11</span> Entity Tags <span class="number">13.3</span><span class="number">.2</span> Entity Tag <span class="keyword">Cache</span> Validators <span class="number">14.19</span> ETag

当然也有第三方nginx- static-etags 模块了，请参考

https://github.com/mikewest/nginx-static-etags

三、对于非实时交互动态页面中Expires和Etag处理

对数据更新并不频繁、如tag分类归档等等，可以考虑对其<span class="keyword">cache</span>。简单点就是在非实时交互的动 态程序中输出expires和etag标识，让其缓存。但需要注意关闭<span class="keyword">session</span>，防止http response时http header包含<span class="keyword">session</span> id标识；

<span class="number">3.1</span>、Expires

如expires.php

&amp;lt;</span>?php

&amp;nbsp;

header(&amp;#39;<span class="operator"><span class="keyword">Cache</span>-Control: <span class="keyword">max</span>-age=<span class="number">86400</span>,must-revalidate&amp;#<span class="number">39</span>;</span>);

&amp;nbsp;

header(&amp;#39;Last-Modified: &amp;#39; .gmdate(&amp;#39;D, d M Y H:i:s&amp;#39;) . &amp;#39; GMT&amp;#39; );

&amp;nbsp;

header(&amp;quot;Expires: &amp;quot; .gmdate (&amp;#39;D, d M Y H:i:s&amp;#39;, time() + &amp;#39;86400&amp;prime; ). &amp;#39; GMT&amp;#39;);

&amp;nbsp;

?&amp;gt;

以上信息表示该文件自请求后24小时后过期。

其他需要处理的动态页面直接调用即可。

3.2、Etag

根据Http返回状态来处理。当返回304直接从缓 存中读取

如etag.php

&amp;gt;

<span class="operator"><span class="keyword">cache</span>();</span>

echo date(&amp;quot;Y-m-d H:i:s&amp;quot;);

function <span class="operator"><span class="keyword">cache</span>()

{

$etag = &amp;quot;</span>http://xok.la&amp;quot;;

if ($_SERVER[&amp;#39;HTTP_IF_NONE_MATCH&amp;#39;] == $etag)

{

header(&amp;#39;Etag:&amp;#39;.$etag,true,304);

exit;

}

else header(&amp;#39;Etag:&amp;#39;.$etag);

}

?&amp;gt;
</code></pre></div><footer class="post__foot u-cf"><a href="/2011/06/21/w/apachenginx-e9-85-8d-e7-bd-ae-cache-last-modified-e3-80-81expires/#comments" class="post__foot-link u-fr">评论</a></footer></article><article class="post"><header class="post__head"><time datetime="2011-06-16T03:21:17.000Z" class="post__time">六月 16, 2011</time><h1 class="post__title"><a href="/2011/06/16/w/e9-80-8f-e6-98-8e-e4-bb-a3-e7-90-86-e8-ae-bf-e9-97-ae-e9-9d-9e80-e7-ab-af-e5-8f-a3/">squid透明代理访问非80端口http服务</a></h1></header><div class="post__main"><p>实现linux服务器配置squid透明代理访问非80端口，允许部分地址不通过代理服务器直接访问。</p>
<p>&nbsp;</p>
<p>iptables相关配置：</p>
<p>*mangle</p>
<pre><code>-A PREROUTING -<span class="keyword">d</span> 10.11.48.0/255.255.255.192 -j <span class="keyword">MARK</span> --<span class="keyword">set</span>-<span class="keyword">mark</span> 0x2

-A PREROUTING -<span class="keyword">d</span> 10.11.48.0/255.255.255.192 -j <span class="literal">RETURN</span>

#以上地址不通过代理

-A PREROUTING -p tcp -<span class="keyword">m</span> tcp --dport 80 -j <span class="keyword">MARK</span> --<span class="keyword">set</span>-<span class="keyword">mark</span> 0x4

-A PREROUTING -p tcp -<span class="keyword">m</span> tcp --dport 80 -j <span class="literal">RETURN</span>

-A PREROUTING -j <span class="keyword">MARK</span> --<span class="keyword">set</span>-<span class="keyword">mark</span> 0x7

-A PREROUTING -j <span class="literal">RETURN</span>

COMMIT

<span class="comment">*filter</span>
</code></pre><p>:INPUT DROP [0:0]</p>
<pre><code><span class="attribute">:FORWARD DROP [0:0]</span>

<span class="attribute">:OUTPUT DROP [0:0]</span>

-A FORWARD -d 10.11.40.0/255.255.255.192 -m state --state NEW -j ACCEPT

-A FORWARD -s 172.168.6.0/255.255.254.0 -p tcp -m multiport --dports 25,110,143 -m state --state NEW -m tcp --tcp-flags SYN,RST,ACK SYN -j ACCEPT

-A FORWARD -s 172.168.6.0/255.255.254.0 -p tcp -m state --state NEW -m tcp --dport 80 --tcp-flags SYN,RST,ACK SYN -j ACCEPT

COMMIT

<span class="strong">*nat

</span>-A PREROUTING -i eth0 -p tcp -m mark --mark 0x4 -m tcp --dport 80 -j REDIRECT --to-ports 3128

#透明代理

-A PREROUTING -i eth0 -p tcp -m tcp --dport 8080 -j REDIRECT --to-ports 3128

#访问非80端口

-A POSTROUTING -s 172.168.6.0/255.255.254.0 -o eth1 -j SNAT --to-source 1.2.3.168

#nat

COMMIT
</code></pre><font class="f14" id="zoom">代理服务器概述<br><br>    &nbsp;<br><br>    1.1什么是代理服务器&nbsp;<br><br>    在TCP/IP网络中，传统的通信过程是这样的：客户端向服务器请求数据，服务器响应该请求，将数据传送给客户端。在引入了代理服务器以后，这一 过程变成了这样：客户端向服务器发起请求，该请求被送到代理服务器；代理服务器分析该请求，先查看自己缓存中是否有请求数据，如果有就直接传送给客户端， 如果没有就代替客户端向该服务器发出请求。服务器响应以后，代理服务器将响应的数据传送给客户端，同时在自己的缓存中保留一份该数据的拷贝。这样，再有客 户端请求相同的数据时，代理服务器就可以直接将数据传送给客户端，而不需要再向该服务器发起请求。<br><br>    &nbsp;<br><br>    1.2&nbsp;代理服务器的功能&nbsp;<br><br>    一般说来，代理服务器具有以下的功能：&nbsp;<br><br>    1.通过缓存增加访问速度&nbsp;<br><br>    随着Internet的迅猛发展，网络带宽变得越来越珍贵。所以为了提高访问速度，好多ISP都提供代理服务器，通过代理服务器的缓存功能来加快 网络的访问速度。一般说来，大多数的代理服务器都支持HTTP缓存，但是，有的代理服务器也支持FTP缓存。在选择代理服务器时，对于大多数的组织，只需 要HTTP缓存功能就足够了。&nbsp;<br><br>    通常，缓存有主动缓存被动缓存之分。所谓被动缓存，指的是代理服务器只在客户端请求数据时才将服务器返回的数据进行缓存，如果数据过期了，又有客 户端请求相同数据时，代理服务器又必须重新发起新的数据请求，在将响应数据传送给客户端时又进行新的缓存。所谓主动缓存，就是代理服务器不断地检查缓存中 的数据，一旦有数据过期，则代理服务器主动发起新的数据请求来更新数据。这样，当有客户端请求该数据时就会大大缩短响应时间。还需要说明的是，对于数据中 的认证信息，大多数的代理服务器都不会进行缓存的。&nbsp;<br><br>    2.提供用私有IP访问Internet的方法&nbsp;<br><br>    IP地址是不可再生的宝贵资源，假如你只有有限的IP地址，但是需要提供整个组织的Internet访问能力，那么，你可以通过使用代理服务器来实现这一点。&nbsp;<br><br>    3.提高网络的安全性&nbsp;<br><br>    这一点是很明显的，如果内部用户访问Internet都是通过代理服务器，那么，代理服务器就成为进入Internet的唯一通道；反过来说，代 理服务器也是Internet访问内部网的唯一通道，如果你没有做反向代理，则对于Internet上的主机来说，你的整个内部网只有代理服务器是可见 的，从而大大增强了网络的安全性。</font>

<p>反向代理:</p>
<pre><code>什么是反向代理呢？其实，反向代理也就是通常所说的WEB服务器加速，它是一种通过在繁忙的WEB服务器和Internet之间增加一个高速的WEB缓冲服务器（即：WEB反向代理服务器）来降低实际的WEB服务器的负载。

Web服务器加速（反向代理）是针对Web服务器提供加速功能的。它作为代理Cache，但并不针对浏览器用户，而针对一台或多台特定Web服务器（这也是反向代理名称的由来）。实施反向代理（如上图所示），只要将<span class="keyword">Reverse</span> Proxy Cache设备放置在一台或多台Web服务器前端即可。当互联网用户访问某个WEB服务器时，通过DNS服务器解析后的IP地址是<span class="keyword">Reverse</span> Proxy Server的IP地址,而非原始Web服务器的IP地址,这时<span class="keyword">Reverse</span> Proxy Server设备充当Web服务器，浏览器可以与它连接，无需再直接与Web服务器相连。因此，大量Web服务工作量被卸载到反向代理服务上。不但能够防止外部网主机直接和web服务器直接通信带来的安全隐患，而且能够很大程度上减轻web服务器的负担，提高访问速度。

反向代理和其它代理的比较

下面将对几种典型的代理服务作一个简单的比较。在网络上常见的代理服务器有三种：

<span class="number">1</span>．&amp;nbsp; 标准的代理缓冲服务器

&amp;nbsp;&amp;nbsp;&amp;nbsp; 一个标准的代理缓冲服务被用于缓存静态的网页（例如：html文件和图片文件等）到本地网络上的一台主机上（即代理服务器）。当被缓存的页面被第二次访问的时候，浏览器将直接从本地代理服务器那里获取请求数据而不再向原web站点请求数据。这样就节省了宝贵的网络带宽，而且提高了访问速度。但是，要想实现这种方式，必须在每一个内部主机的浏览器上明确指明代理服务器的IP地址和端口号。客户端上网时，每次都把请求送给代理服务器处理，代理服务器根据请求确定是否连接到远程web服务器获取数据。如果在本地缓冲区有目标文件，则直接将文件传给用户即可。如果没有的话则先取回文件，先在本地保存一份缓冲，然后将文件发给客户端浏览器。

<span class="number">2</span>．&amp;nbsp; 透明代理缓冲服务器

&amp;nbsp; &lt;span style=<span class="string">"font-family: DejaVu sans;"</span>&gt;通常使用代理，大家都是在浏览器里面的代理选项中填入代理信息，开启代理功能。而透明代理则是在网关通过把客户端的请求重定向到代理服务器的代理端口，让客户端感觉不到代理的存在，当然，客户端也就无须任何代理设置。&lt;<span class="regexp">/span&gt;</span>
</code></pre><p>透明代理缓冲服务和标准代理服务器的功能完全相同。但是，代理操作对客户端的浏览器是透明的（即不需指明代理服务器的IP和端口）。透明代理服务器阻断网络通信，并且过滤出访问外部的HTTP（80端口）流量。如果客户端的请求在本地有缓冲则将缓冲的数据直接发给用户，如果在本地没有缓冲则向远程web服务器发出请求，其余操作和标准的代理服务器完全相同。对于Linux操作系统来说，透明代理使用Iptables或者Ipchains实现。因为不需要对浏览器作任何设置，所以，透明代理对于ISP（Internet服务器提供商）特别有用。</p>
<pre><code>3．&amp;nbsp; 反向代理缓冲服务器

&amp;nbsp;&amp;nbsp;&amp;nbsp; 反向代理是和前两种代理完全不同的一种代理服务。使用它可以降低原始WEB服务器的负载。反向代理服务器承担了对原始WEB服务器的静态页面的请求，防止原始服务器过载。它位于本地WEB服务器和Internet之间，处理所有对WEB服务器的请求，组织了WEB服务器和Internet的直接通信。如果互联网用户请求的页面在代理服务器上有缓冲的话，代理服务器直接将缓冲内容发送给用户。如果没有缓冲则先向WEB服务器发出请求，取回数据，本地缓存后再发送给用户。这种方式通过降低了向WEB服务器的请求数从而降低了WEB服务器的负载。
</code></pre></div><footer class="post__foot u-cf"><a href="/2011/06/16/w/e9-80-8f-e6-98-8e-e4-bb-a3-e7-90-86-e8-ae-bf-e9-97-ae-e9-9d-9e80-e7-ab-af-e5-8f-a3/#comments" class="post__foot-link u-fr">评论</a></footer></article><article class="post"><header class="post__head"><time datetime="2011-05-25T06:53:07.000Z" class="post__time">五月 25, 2011</time><h1 class="post__title"><a href="/2011/05/25/w/mysql-5-5-12-e5-ae-89-e8-a3-85-e5-92-8c-e5-8d-87-e7-ba-a7/">mysql 5.5.12安装和升级</a></h1></header><div class="post__main"><p>mysql 5.5中InnoDB作为默认的数据库存储引擎，mysql-5.1升级mysql到mysql-5.5以后，以下程序需要重新编译安装升级：</p>
<pre><code>PHP <span class="number">5.3</span><span class="number">.6</span>

cacti spine

pureftp

安装

wget <span class="string">http:</span><span class="comment">//dev.mysql.com/get/Downloads/MySQL-5.5/mysql-5.5.12-linux2.6-x86_64.tar.gz/from/http://mysql.ntu.edu.tw/</span>

tar -C <span class="regexp">/usr/</span>local -xzf&amp;nbsp; mysql-<span class="number">5.5</span><span class="number">.12</span>-linux2<span class="number">.6</span>-x86_64.tar.gz

cd <span class="regexp">/usr/</span>local

ln -s mysql-<span class="number">5.5</span><span class="number">.12</span>-linux2<span class="number">.6</span>-x86_64/ mysql

cd <span class="regexp">/usr/</span>local/mysql

mkdir -p <span class="regexp">/usr/</span>local<span class="regexp">/mysql/</span>etc/

cp support-files<span class="regexp">/my-huge.cnf etc/</span>my.cnf

sed -i &amp;#<span class="number">39</span>;s<span class="regexp">/skip-locking/</span>skip-external-locking/&amp;#<span class="number">39</span>; my.cnf

sed -i &amp;#<span class="number">39</span>;s<span class="regexp">/default-character-set/</span>character-set-server/&amp;#<span class="number">39</span>; my.cnf

sed -i &amp;#<span class="number">39</span>;s<span class="regexp">/log_slow_queries/</span>slow_query_log/&amp;#<span class="number">39</span>; my.cnf

修改server-id = <span class="number">1</span>为服务器ip地址最后几位，或者其它数值：

cd <span class="regexp">/usr/</span>local<span class="regexp">/mysql/</span>etc/

vim&amp;nbsp; my.cnf

#max_allowed_packet = <span class="number">1</span>M

server-id = <span class="number">8108</span>

max_allowed_packet = <span class="number">64</span>M

max_connections=<span class="number">800</span>

character-set-server=utf8

expire_logs_days = <span class="number">60</span>

binlog_format=mixed

log-bin=mysql-bin

#read_only=<span class="number">1</span>

#slave-skip-errors=<span class="number">1062</span>,<span class="number">1032</span>,<span class="number">1053</span>

innodb_log_files_in_group=<span class="number">2</span>

#default_table_type = INNODB <span class="comment">//unknown variable</span>

innodb_data_home_dir = <span class="regexp">/opt/</span>data<span class="regexp">/mysql/</span>

innodb_data_file_path = <span class="string">ibdata1:</span><span class="number">2000</span>M;<span class="string">ibdata2:</span><span class="number">2000</span>M;<span class="string">ibdata3:</span><span class="number">20</span><span class="string">M:</span>autoextend

innodb_log_group_home_dir = <span class="regexp">/opt/</span>data<span class="regexp">/mysql/</span>

# <span class="number">4</span>G RAM

innodb_buffer_pool_size = <span class="number">1</span>G

innodb_log_file_size = <span class="number">256</span>M

innodb_log_buffer_size = <span class="number">8</span>M

innodb_flush_log_at_trx_commit=<span class="number">0</span>

innodb_thread_concurrency=<span class="number">8</span>

innodb_flush_method=O_DIRECT

# perform

tmp_table_size = <span class="number">512</span>M

max_heap_table_size=<span class="number">128</span>M

slow_query_log

#log-queries-not-using-indexes

#log-slow-admin-statements

#slow_query_log_file=mysql-slow.log

long_query_time=<span class="number">1</span>

log-error=mysqld.log

[mysqld_safe]

log-error=<span class="regexp">/var/</span>log/mysqld.log

pid-file=<span class="regexp">/var/</span>run<span class="regexp">/mysqld/</span>mysqld.pid

添加数据库用户

<span class="regexp">/usr/</span>sbin/groupadd -g <span class="number">502</span> mysql

<span class="regexp">/usr/</span>sbin/useradd -u <span class="number">502</span> -g mysql mysql

mkdir -p <span class="regexp">/opt/</span>data<span class="regexp">/mysql/</span>

chown mysql.mysql <span class="regexp">/opt/</span>data<span class="regexp">/mysql/</span>

cd <span class="regexp">/usr/</span>local<span class="regexp">/mysql/</span>

scripts/mysql_install_db --user=mysql

chown -R root .

chown -R mysql data

chgrp -R mysql .

#chmod -R u+rw data

cd <span class="regexp">/opt/</span>data<span class="regexp">/mysql/</span>

chown mysql.mysql <span class="regexp">/opt/</span>data<span class="regexp">/mysql/</span>

cd <span class="regexp">/usr/</span>local<span class="regexp">/mysql/</span>

cp support-files<span class="regexp">/mysql.server /</span>etc<span class="regexp">/rc.d/</span>init.d/mysqld

chmod +x <span class="regexp">/etc/</span>rc.d<span class="regexp">/init.d/</span>mysqld

<span class="regexp">/etc/</span>rc.d<span class="regexp">/init.d/</span>mysqld restart

#<span class="regexp">/sbin/</span>chkconfig --level <span class="number">345</span> mysqld on

#<span class="regexp">/sbin/</span>chkconfig --del mysqld

<span class="regexp">/sbin/</span>chkconfig --add mysqld

<span class="regexp">/sbin/</span>chkconfig --list mysqld

echo &amp;quot;<span class="regexp">/usr/</span>local<span class="regexp">/mysql/</span>lib&amp;quot; &amp;gt;&amp;gt; <span class="regexp">/etc/</span>ld.so.conf

cat <span class="regexp">/etc/</span>ld.so.conf

ldconfig

mkdir -p <span class="regexp">/var/</span>lib<span class="regexp">/mysql/</span>

ln -s <span class="regexp">/tmp/</span>mysql.sock <span class="regexp">/var/</span>lib<span class="regexp">/mysql/</span>mysql.sock

#<span class="regexp">/usr/</span>local<span class="regexp">/mysql/</span>bin/mysqld_safe &amp;amp;

mkdir -p <span class="regexp">/var/</span>run<span class="regexp">/mysqld/</span>

chown mysql <span class="regexp">/var/</span>run<span class="regexp">/mysqld/</span>

#加入mysql到路径

echo pathmunge <span class="regexp">/usr/</span>local<span class="regexp">/mysql/</span>bin after &amp;gt; <span class="regexp">/etc/</span>profile.d/mysql.sh

#执行一下，保证mysql在路径环境变量中

. <span class="regexp">/etc/</span>profile

mysql5<span class="number">.1</span>升级到mysql5<span class="number">.5</span>

mysql_upgrade包含一下三个命令：

# mysqlcheck --check-upgrade --all-databases --auto-repair

# mysql_fix_privilege_tables

# mysqlcheck --all-databases --check-upgrade --fix-db-names --fix-table-names

在每一次的升级过程中，建议执行mysql_upgrade这个命令，通过mysqlcheck命令帮我们去检查表是否兼容新版本的数据库同时作出修复，使用mysql_fix_privilege_tables命令去升级权限表。

<span class="regexp">/usr/</span>local<span class="regexp">/mysql/</span>bin/mysql_upgrade -uroot -p

[ERROR] <span class="regexp">/usr/</span>local<span class="regexp">/mysql/</span>bin/<span class="string">mysqld:</span> unknown variable &amp;#<span class="number">39</span>;default_table_type=INNODB&amp;#<span class="number">39</span>;

注释my.cnf中的default_table_type=INNODB

把所有INNODB表转换成MYISAM表的脚本

sed -i &amp;#<span class="number">39</span>;s<span class="regexp">/$opt_type/</span>$opt_engine<span class="regexp">/&amp;#39; /</span>usr<span class="regexp">/local/</span>mysql<span class="regexp">/bin/</span>mysql_convert_table_format

<span class="regexp">/usr/</span>local<span class="regexp">/mysql/</span>bin<span class="regexp">/mysql_convert_table_format --user=&amp;#39;root&amp;#39; --password=&amp;#39;veryi.com&amp;#39; --socket=&amp;#39;/</span>tmp/mysql.sock&amp;#<span class="number">39</span>; --type=&amp;#<span class="number">39</span>;INNODB&amp;#<span class="number">39</span>; 

&amp;nbsp;
</code></pre></div><footer class="post__foot u-cf"><a href="/2011/05/25/w/mysql-5-5-12-e5-ae-89-e8-a3-85-e5-92-8c-e5-8d-87-e7-ba-a7/#comments" class="post__foot-link u-fr">评论</a></footer></article><article class="post"><header class="post__head"><time datetime="2011-05-25T03:57:42.000Z" class="post__time">五月 25, 2011</time><h1 class="post__title"><a href="/2011/05/25/w/cacti-sql-failed-error1062-e6-95-85-e9-9a-9c-e6-8e-92-e9-99-a4/">cacti SQL Failed! Error:'1062'故障排除</a></h1></header><div class="post__main"><p>cacti日志报错：</p>
<p>05/25/2011 11:40:01 AM - SPINE: Poller[0] ERROR: SQL Failed! Error:&#39;1062&#39;, Message:&#39;Duplicate entry &#39;3-mem_buffers-2011-05-25 11:40:01&#39; for key &#39;PRIMARY&#39;&#39;, SQL Fragment:&#39;INSERT INTO poller_output (local_data_id, rrd_name, time, output) VALUES (3,&#39;mem_buffers&#39;,&#39;2011-05-25 11:40:01&#39;,&#39;927912&#39;),(4,&#39;mem_swap&#39;,&#39;2011-05-25 11:40:01&#39;,&#39;4192956&#39;),(5,&#39;&#39;,&#39;2011-05-25 11:40:01&#39;,&#39;1min:0.10 5min:0.16 10min:0.23&#39;),(6,&#39;users&#39;,&#39;2011-05-25 11:40:01&#39;,&#39;4&#39;),(7,&#39;proc&#39;,&#39;2011-05-25 11:40:01&#39;,&#39;169&#39;),(8,&#39;hdd_free&#39;,&#39;2011-05-25 11:40:01&#39;,&#39;47949780&#39;),(8,&#39;hdd_used&#39;,&#39;2011-05-25 11:40:01&#39;,&#39;44424292&#39;)&#39;</p>
<pre><code>Check

- <span class="regexp">/etc/</span>crontab

- <span class="regexp">/etc/</span>cron.d/cacti

- crontab of root and cactiuser 

cat <span class="regexp">/etc/</span>crontab

SHELL=<span class="regexp">/bin/</span>bash

PATH=<span class="regexp">/sbin:/</span><span class="string">bin:</span><span class="regexp">/usr/</span><span class="string">sbin:</span><span class="regexp">/usr/</span>bin

MAILTO=root

HOME=/

# run-parts

<span class="number">01</span> * * * * root run-parts <span class="regexp">/etc/</span>cron.hourly

<span class="number">02</span> <span class="number">4</span> * * * root run-parts <span class="regexp">/etc/</span>cron.daily

<span class="number">22</span> <span class="number">4</span> * * <span class="number">0</span> root run-parts <span class="regexp">/etc/</span>cron.weekly

<span class="number">42</span> <span class="number">4</span> <span class="number">1</span> * * root run-parts <span class="regexp">/etc/</span>cron.monthly
</code></pre><p>crontab -l -u cactiuser</p>
<pre><code>*<span class="regexp">/5 * * * * /</span>usr<span class="regexp">/local/</span>php<span class="regexp">/bin/</span>php&amp;nbsp; <span class="regexp">/opt/</span>local<span class="regexp">/www/</span>html<span class="regexp">/cacti/</span>poller.php &amp;gt; <span class="regexp">/dev/</span><span class="literal">null</span> <span class="number">2</span>&amp;gt;&amp;amp;<span class="number">1</span>

cat <span class="regexp">/etc/</span>cron.d/cacti 

*<span class="regexp">/5 * * * *&amp;nbsp;&amp;nbsp;&amp;nbsp; cacti&amp;nbsp;&amp;nbsp;&amp;nbsp; php /</span>var<span class="regexp">/www/</span>cacti<span class="regexp">/poller.php &amp;amp;&amp;gt;/</span>dev/<span class="literal">null</span>

注释以上语句故障排除。

&amp;nbsp;
</code></pre></div><footer class="post__foot u-cf"><a href="/2011/05/25/w/cacti-sql-failed-error1062-e6-95-85-e9-9a-9c-e6-8e-92-e9-99-a4/#comments" class="post__foot-link u-fr">评论</a></footer></article><article class="post"><header class="post__head"><time datetime="2011-05-16T09:31:55.000Z" class="post__time">五月 16, 2011</time><h1 class="post__title"><a href="/2011/05/16/w/postfix-e9-82-ae-e4-bb-b6-e6-9c-8d-e5-8a-a1-e5-99-a8-e5-ae-89-e5-85-a8/">postfix邮件服务器安全</a></h1></header><div class="post__main"><p>配置extmail不允许伪造不存在的本地邮件地址发邮件,不允许并仿冒他人邮件地址发送邮件</p>
<pre><code>cd /etc/postfix/

cat &amp;gt;mysql_virtual_sender_maps.cf&amp;lt;&amp;lt;EOF

<span class="variable">user =</span> extmail

<span class="variable">password =</span> extmail

<span class="variable">hosts =</span> localhost

<span class="variable">dbname =</span> extmail

<span class="variable">table =</span> mailbox

<span class="variable">select_field =</span> username

<span class="variable">where_field =</span> username

<span class="variable">additional_conditions =</span> AND <span class="variable">active =</span> &amp;<span class="comment">#39;1&amp;#39;</span>

EOF

vim main.cf

<span class="variable">smtpd_sender_login_maps =</span>

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; mysql:/etc/postfix/mysql_virtual_sender_maps.cf

<span class="variable">smtpd_sender_restrictions =</span>

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; permit_mynetworks,

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; reject_sender_login_mismatch,

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; reject_authenticated_sender_login_mismatch,

&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; reject_unauthenticated_sender_login_mismatch
</code></pre><p>使配置生效</p>
<pre><code><span class="title">postfix</span> reload
</code></pre></div><footer class="post__foot u-cf"><a href="/2011/05/16/w/postfix-e9-82-ae-e4-bb-b6-e6-9c-8d-e5-8a-a1-e5-99-a8-e5-ae-89-e5-85-a8/#comments" class="post__foot-link u-fr">评论</a></footer></article></main><aside class="site-aside"><div class="widget about"><div class="b"><div class="info u-cf"><img src="/avatar.jpg"><div class="text"> <p>dayu graceful</p><p>vegan</p><p>linux sysadm</p><p> <a href="dayu2829@sina.com" title="wiebo" class="weibo ico"></a><a href="kindquiet@qq.com" title="qq" class="qq ico"></a></p></div></div></div></div><div class="widget tags"><div class="h">categories</div><div class="b"> <ul><li><a href="/categories/计算机/">计算机</a><small>(136)</small></li><li><a href="/categories/佛法传统文化/">佛法传统文化</a><small>(18)</small></li><li><a href="/categories/健康/">健康</a><small>(13)</small></li><li><a href="/categories/学习/">学习</a><small>(3)</small></li><li><a href="/categories/网络/">网络</a><small>(1)</small></li><li><a href="/categories/佛法传统文化/健康/">健康</a><small>(1)</small></li></ul></div></div><div class="widget links"><div class="h">links</div><div class="b"> <ul><li><a href="http://www.enzymesos.com/">酵素Enzyme救地球</a></li><li><a href="http://www.osalt.com/">商业软件的开源替代品</a></li></ul></div></div></aside></section><footer class="site-foot"><div class="inner"><div class="site-copy u-fl">© 2015 dayu<bdi> ❤ Theme by <a href="http://riny.net" target="_blank">Bubblings</a></bdi></div><menu class="page-menu u-fr"><li class="page-menu__item"><a title="Previous" href="/categories/计算机/page/5/" class="page-menu__link icon-arrow-left">prev</a></li><li class="page-menu__item"><a title="Next" href="/categories/计算机/page/7/" class="page-menu__link icon-arrow-right">next</a></li></menu></div></footer><div id="back-top" title="返回顶部"></div><script src="/js/script.js"></script></body></html>